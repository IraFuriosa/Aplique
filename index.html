<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Investimentos</title>
  <!-- Tailwind CSS para estilização moderna e responsiva -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configuração da fonte Inter e estilos aprimorados -->
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --success: #10b981;
      --error: #ef4444;
      --background-light: #f9fafb;
      --card-bg: #ffffff;
    }

    /* Estilo global aprimorado */
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-light); /* Fundo mais suave */
      color: #1f2937;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Estilos personalizados para botões */
    .btn-primary {
      @apply bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out;
    }
    .btn-secondary {
      @apply bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-gray-800 font-semibold py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 ease-in-out;
    }
    .btn-danger {
      @apply bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition-all duration-200 ease-in-out;
    }
    .btn-success {
      @apply bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition-all duration-200 ease-in-out;
    }
    .btn-tertiary {
      @apply bg-white border border-gray-300 text-gray-700 font-medium py-2.5 px-4 rounded-lg shadow-sm hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out;
    }
    .btn-status {
      @apply text-xs font-bold px-3 py-1 rounded-full shadow-inner transition-colors duration-150 ease-in-out;
    }
    .btn-status-vencido {
      @apply bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 border border-gray-400;
    }
    .btn-status-hoje {
      @apply bg-gradient-to-r from-green-200 to-green-300 text-green-800 border border-green-300;
    }
    .btn-status-proximo {
      @apply bg-gradient-to-r from-red-200 to-red-300 text-red-800 border border-red-300;
    }
    .btn-status-distantes {
      @apply bg-gradient-to-r from-yellow-200 to-yellow-300 text-yellow-800 border border-yellow-300;
    }

    /* Estilo para Chart.js */
    .chart-container {
      max-height: 450px;
    }

    /* Estilo para os cards principais */
    .app-card {
        @apply bg-white shadow-2xl rounded-2xl p-8 border border-gray-100 transition duration-300 hover:shadow-indigo-100/50;
    }

    /* Estilo para os inputs */
    input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"], select {
        @apply transition duration-150 ease-in-out border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 rounded-lg shadow-sm p-3;
    }

    /* Estilo para a lista de investimentos */
    .investment-item {
        @apply flex items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm transition duration-150 ease-in-out hover:bg-indigo-50/50 hover:shadow-md;
    }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            'indigo': {
              50: '#eef2ff',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
            }
          }
        }
      }
    }
  </script>
</head>
<body>

  <!-- Mensagem de Feedback (Substitui alert()) -->
  <div id="feedback-message" class="fixed top-5 right-5 p-4 rounded-xl shadow-2xl text-white transform transition-transform duration-500 z-50 hidden"></div>

  <!-- Modal de Confirmação de Exclusão (Substitui window.confirm) -->
  <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-3xl p-8 w-11/12 max-w-sm">
      <h3 class="text-2xl font-extrabold text-red-700 mb-4 flex items-center">
        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        Confirmar Exclusão
      </h3>
      <p class="text-gray-600 mb-6" id="delete-modal-text">Esta ação é irreversível. Tem certeza de que deseja excluir permanentemente este investimento?</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-delete" class="btn-tertiary py-2 px-4">Cancelar</button>
        <button id="confirm-delete" class="btn-danger py-2 px-4">Excluir</button>
      </div>
    </div>
  </div>

  <!-- #auth-container: TELA DE LOGIN/CADASTRO -->
  <div id="auth-container" class="flex-grow flex items-center justify-center p-4">
    <div class="app-card w-full max-w-md text-center">
        <h2 class="text-3xl font-extrabold text-indigo-700 mb-6" id="auth-title">Acesse sua Carteira</h2>

        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="sr-only">E-mail</label>
                <input type="email" id="auth-email" required class="w-full text-base" placeholder="Seu e-mail" autocomplete="username">
            </div>
            <div>
                <label for="auth-password" class="sr-only">Senha</label>
                <input type="password" id="auth-password" required class="w-full text-base" placeholder="Sua senha" autocomplete="current-password">
            </div>
            <div id="auth-error-message" class="text-red-600 text-sm hidden"></div>

            <button type="submit" id="auth-submit-btn" class="btn-primary w-full">
                <span id="auth-btn-text">Entrar</span>
                <svg id="auth-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </form>
    </div>
  </div>
  <!-- FIM TELA DE LOGIN/CADASTRO -->

  <!-- #app-container: APLICAÇÃO PRINCIPAL -->
  <div id="app-container" class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8 hidden flex-grow">
    <header class="text-center mb-12 py-4 bg-gradient-to-r from-indigo-600 to-indigo-800 rounded-xl shadow-xl flex flex-col md:flex-row justify-between items-center px-8">
      <div class="text-left mb-4 md:mb-0">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-white">Gerenciador de Investimentos</h1>
        <p class="mt-1 text-sm sm:text-base text-indigo-100">
            Logado como: <span id="user-email-display" class="font-bold"></span>
        </p>
      </div>
      <button id="logout-button" class="btn-danger py-2.5 px-6 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          Sair
      </button>
    </header>

    <!-- Seção de Cadastro -->
    <section class="app-card mb-10">
      <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-indigo-700">Novo Investimento</h2>
      <form id="investimentoForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        <!-- 1. Tipo de Investimento (Select) -->
        <div>
          <label for="nomeId" class="block text-sm font-semibold text-gray-700">Nome</label>
          <select id="nomeId" name="nomeId" required class="mt-1 block w-full text-base sm:text-sm">
            <option value="">Carregando...</option>
          </select>
        </div>

        <!-- 2. Taxa de Juros (Input) -->
        <div>
          <label for="taxaJuros" class="block text-sm font-semibold text-gray-700">Taxa Juros Mensal (%)</label>
          <input type="number" step="0.01" id="taxaJuros" name="taxaJuros" required value="10.00" class="mt-1 block w-full sm:text-sm" placeholder="Ex: 10.00">
          <p id="taxa_juros_error" class="mt-1 text-xs text-red-600"></p>
        </div>

        <!-- 3. Valor Investido -->
        <div>
          <label for="valor" class="block text-sm font-semibold text-gray-700">Valor Investido (R$)</label>
          <input type="text" id="valor" name="valor" required class="mt-1 block w-full sm:text-sm" placeholder="Ex: R$ 1.000,00">
          <p id="valor_error" class="mt-1 text-xs text-red-600"></p>
        </div>

        <!-- 4. Data de Início -->
        <div>
          <label for="entrada" class="block text-sm font-semibold text-gray-700">Data de Início</label>
          <input type="date" id="entrada" name="entrada" required class="mt-1 block w-full sm:text-sm">
        </div>

        <!-- 5. Data de Resgate -->
        <div>
          <label for="retorno" class="block text-sm font-semibold text-gray-700">Data de Resgate</label>
          <input type="date" id="retorno" name="retorno" required class="mt-1 block w-full sm:text-sm">
          <p id="resgate_error" class="mt-1 text-xs text-red-600"></p>
        </div>

        <!-- 6. Dias Totais para Resgate (Display) -->
        <div>
            <label class="block text-sm font-semibold text-gray-700">Prazo Total (Dias)</label>
            <div id="dias-totais-display" class="mt-1 block w-full bg-indigo-50 text-indigo-700 font-extrabold text-lg p-3 rounded-lg border border-indigo-200">
                0 dias
            </div>
        </div>

        <!-- 7. Valor de Resgate (Haver) -->
        <div>
            <label for="haver" class="block text-sm font-semibold text-gray-700">Resgate Programado (R$)</label>
            <input type="number" step="0.01" id="haver" name="haver" class="mt-1 block w-full bg-gray-100 text-gray-800 font-semibold sm:text-sm" placeholder="Automático (pode editar)" readonly>
        </div>

        <!-- 8. Botão de Cadastro -->
        <div class="lg:col-span-1 flex justify-end items-end">
          <button type="submit" class="btn-primary w-full md:w-auto h-[44px]">
            <span id="submit-text">Cadastrar Investimento</span>
            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      </form>
    </section>

    <!-- Seção de Visualização -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- Gráfico de Pizza -->
      <div class="app-card chart-container">
        <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-indigo-700">Distribuição da Carteira (Global)</h2>
        <div class="h-full w-full flex items-center justify-center">
            <canvas id="investimentoChart"></canvas>
        </div>
      </div>

      <!-- Lista de Investimentos -->
      <div class="app-card">
        <h2 class="text-2xl font-bold mb-6 border-b pb-3 text-indigo-700">Carteira Compartilhada</h2>

        <div id="investimento-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
          <!-- Dados carregados aqui -->
          <p id="loading-text" class="text-center text-gray-500 py-8">Faça login para ver os investimentos.</p>
        </div>

        <!-- Resumo Total -->
        <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="space-y-2">
                <p class="text-xl font-extrabold text-gray-800 flex justify-between">
                    <span>Total Investido:</span>
                    <span id="total-investido" class="text-indigo-600">R$ 0,00</span>
                </p>
                <p class="text-xl font-extrabold text-gray-800 flex justify-between">
                    <span>Total a Resgatar:</span>
                    <span id="total-haver" class="text-green-600">R$ 0,00</span>
                </p>
            </div>
        </div>
      </div>
    </section>
  </div>
  <!-- Fim da Aplicação Principal -->

  <script type="module">

    // --- Configuração Supabase ---
    // ATENÇÃO: Preencha com suas chaves.
    const SUPABASE_URL = 'https://odaalhsghdmpyhgnblml.supabase.co'; // COLOQUE SEU URL AQUI
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kYWFsaHNnaGRtcHloZ25ibG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzMyODUsImV4cCI6MjA3NjU0OTI4NX0.J3bgvqGOh2KsNPhuQbnAcGsmNnsqxktIygOpJqr1cHM'; // COLOQUE SUA CHAVE ANON AQUI

    let supabase = null;
    let supabaseConfigured = false;
    // currentUserId é mantido apenas para referência, mas não será usado para filtrar dados.
    let currentUserId = null;

    if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        // Inicialização do Supabase Client
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        supabaseConfigured = true;
    } else {
        console.error("ERRO DE CONFIGURAÇÃO: Por favor, configure SUPABASE_URL e SUPABASE_ANON_KEY no código-fonte.");
    }

    let investmentToDeleteId = null;
    let investimentoChart;
    let authMode = 'login'; // 'login' ou 'signup'

    const DIAS_NO_MES = 30.4375;

    // Elementos do DOM
    const appContainer = document.getElementById('app-container');
    const authContainer = document.getElementById('auth-container');
    const submitButton = document.getElementById('investimentoForm').querySelector('button[type="submit"]');
    const loadingSpinner = document.getElementById('loading-spinner');
    const submitText = document.getElementById('submit-text');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authBtnText = document.getElementById('auth-btn-text');
    const authLoadingSpinner = document.getElementById('auth-loading-spinner');
    const authErrorMessage = document.getElementById('auth-error-message');


    // Função para exibir mensagem de feedback (sucesso/erro)
    function showFeedback(message, type = 'success') {
        const feedbackEl = document.getElementById('feedback-message');
        feedbackEl.textContent = message;

        feedbackEl.className = 'fixed top-5 right-5 p-4 rounded-xl shadow-2xl text-white transform transition-transform duration-500 z-50';

        if (type === 'success') {
            feedbackEl.classList.add('bg-green-600', 'translate-x-0');
        } else {
            feedbackEl.classList.add('bg-red-600', 'translate-x-0');
        }

        feedbackEl.classList.remove('hidden', 'translate-x-full');

        setTimeout(() => {
            feedbackEl.classList.add('translate-x-full');
            feedbackEl.classList.remove('translate-x-0');
            setTimeout(() => {
                 feedbackEl.classList.add('hidden');
            }, 500);
        }, 5000);
    }

    // --- LÓGICA DE AUTENTICAÇÃO ---

    /**
     * Alterna entre modo Login e Cadastro.
     */
    function toggleAuthMode() {
        const title = document.getElementById('auth-title');
        const switchText = document.getElementById('auth-switch-text');
        const switchButton = document.getElementById('auth-switch-mode');

        if (authMode === 'login') {
            authMode = 'signup';
            title.textContent = 'Crie sua Conta';
            authBtnText.textContent = 'Cadastrar';
            switchText.textContent = 'Já tem conta?';
            switchButton.textContent = 'Faça login aqui';
        } else {
            authMode = 'login';
            title.textContent = 'Acesse sua Carteira';
            authBtnText.textContent = 'Entrar';
            switchText.textContent = 'Não tem conta?';
            switchButton.textContent = 'Crie sua conta aqui';
        }
        document.getElementById('auth-form').reset();
        authErrorMessage.classList.add('hidden');
    }

    /**
     * Processa o Login ou Cadastro.
     */
    async function handleAuth(email, password) {
        authSubmitBtn.disabled = true;
        authBtnText.classList.add('hidden');
        authLoadingSpinner.classList.remove('hidden');
        authErrorMessage.classList.add('hidden');

        let response;
        if (authMode === 'login') {
            response = await supabase.auth.signInWithPassword({ email, password });
        } else {
            // Apenas email/password, sem provedores externos
            response = await supabase.auth.signUp({ email, password });
        }

        authSubmitBtn.disabled = false;
        authBtnText.classList.remove('hidden');
        authLoadingSpinner.classList.add('hidden');

        if (response.error) {
            authErrorMessage.textContent = response.error.message;
            authErrorMessage.classList.remove('hidden');
            console.error('Auth Error:', response.error);
        } else if (authMode === 'signup' && !response.data.user) {
             // Caso de signUp com RLS ativado (requer confirmação de email)
             showFeedback('Verifique seu email para confirmar a conta antes de fazer o login.', 'success');
        } else {
            // Sucesso! onAuthStateChange cuidará do resto.
            // Se o signup for bem-sucedido e o usuário logar automaticamente (padrão Supabase sem confirmação de e-mail),
            // a mensagem de login/cadastro é mostrada.
            document.getElementById('auth-form').reset();
            if (authMode === 'signup' && response.data.user) {
                showFeedback('Conta criada com sucesso! Você foi logado automaticamente.', 'success');
            } else if (authMode === 'login') {
                showFeedback('Login realizado com sucesso!', 'success');
            }
        }
    }

    /**
     * Configura o listener para alternar as telas de login/app.
     */
    function setupAuthListener() {
        if (!supabaseConfigured) return;

        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUserId = session.user.id;
                console.log('User signed in:', currentUserId);

                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                // Carrega dados (compartilhados por todos)
                carregarNomes();
                carregarDados();

                // Atualiza o email
                const emailDisplay = document.getElementById('user-email-display');
                if (emailDisplay) emailDisplay.textContent = session.user.email;

            } else {
                currentUserId = null;
                console.log('User signed out.');
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');

                // Limpa listas e gráficos
                if (investimentoChart) {
                    investimentoChart.destroy();
                    investimentoChart = null;
                }
                document.getElementById('investimento-list').innerHTML = '<p id="loading-text" class="text-center text-gray-500 py-8">Faça login para ver os investimentos.</p>';
                document.getElementById('total-investido').textContent = formatarMoeda(0);
                document.getElementById('total-haver').textContent = formatarMoeda(0);
            }
        });
    }

    /**
     * Função para Logout
     */
    async function handleLogout() {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error('Logout Error:', error);
            showFeedback('Erro ao sair: ' + error.message, 'error');
        } else {
            showFeedback('Logout realizado com sucesso!');
        }
    }

    // --- FIM LÓGICA DE AUTENTICAÇÃO ---


    // Função para calcular dias entre duas datas
    const calcularDias = (data1, data2) => {
        const d1 = new Date(data1);
        const d2 = new Date(data2);
        const diffTime = Math.abs(d2.getTime() - d1.getTime());
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    };

    // Função para formatar moeda brasileira
    const formatarMoeda = (valor) => {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
        }).format(valor);
    };

    // FUNÇÃO CRÍTICA: Obtém o valor numérico de um campo formatado
    const getValorNumerico = (valorFormatado) => {
        if (!valorFormatado) return 0;
        let cleaned = valorFormatado.replace(/[^0-9,]/g, '');
        cleaned = cleaned.replace(',', '.');
        return parseFloat(cleaned) || 0;
    };

    /**
     * Função para formatar o campo de input em tempo real (Padrão: R$ X.XXX,XX)
     */
    function formatarInputMoeda(e) {
        let value = e.target.value;
        value = value.replace(/\D/g, '').slice(0, 18);

        if (!value) {
            e.target.value = '';
            return;
        }

        const paddedValue = value.padStart(3, '0');
        const centavos = paddedValue.slice(-2);
        let reais = parseInt(paddedValue.slice(0, -2), 10).toString();

        reais = reais.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        const formattedValue = `R$ ${reais},${centavos}`;
        e.target.value = formattedValue;
    }


    // Função para calcular o haver (juros composto dinâmico) e os dias totais e atualiza a UI
    function calcularEExibirHaverEDias() {
        const valorEl = document.getElementById('valor');
        const entradaEl = document.getElementById('entrada');
        const retornoEl = document.getElementById('retorno');
        const haverEl = document.getElementById('haver');
        const diasDisplayEl = document.getElementById('dias-totais-display');
        const taxaJurosEl = document.getElementById('taxaJuros');

        const valor = getValorNumerico(valorEl.value);
        const taxaJurosPercentual = parseFloat(taxaJurosEl.value);
        const dataInicio = entradaEl.value;
        const dataResgate = retornoEl.value;

        document.getElementById('taxa_juros_error').textContent = '';
        haverEl.value = '';
        diasDisplayEl.textContent = '0 dias';

        if (taxaJurosPercentual <= 0 || isNaN(taxaJurosPercentual)) {
            document.getElementById('taxa_juros_error').textContent = 'A taxa deve ser positiva.';
            return;
        }

        const taxaMensalDecimal = taxaJurosPercentual / 100;

        if (!valor || valor <= 0 || !dataInicio || !dataResgate) {
            return;
        }

        if (new Date(dataInicio) >= new Date(dataResgate)) {
             document.getElementById('resgate_error').textContent = 'A data de resgate deve ser posterior à data de início.';
             return;
        }
        document.getElementById('resgate_error').textContent = '';


        const diasTotais = calcularDias(dataInicio, dataResgate);
        diasDisplayEl.textContent = `${diasTotais} dias`;

        const meses = diasTotais / DIAS_NO_MES;

        const haverCalculado = valor * Math.pow((1 + taxaMensalDecimal), meses);

        haverEl.value = haverCalculado.toFixed(2);
    }

    // Função para carregar os tipos de investimento (da tabela NOMES)
    async function carregarNomes() {
        const selectElement = document.getElementById('nomeId');

        selectElement.innerHTML = '<option value="">Carregando...</option>';

        if (!supabaseConfigured) {
            selectElement.innerHTML = '<option value="">ERRO: Configurar Supabase!</option>';
            return;
        }

        // Buscando nomes (assumindo que a tabela NOMES é de acesso público/autenticado)
        const { data, error } = await supabase
            .from('NOMES')
            .select('nome');

        if (error) {
            console.error('Erro ao carregar tipos de investimento:', error);
            showFeedback('Erro ao carregar tipos: Verifique se a tabela NOMES existe. Detalhe: ' + error.message, 'error');
            return;
        }

        selectElement.innerHTML = '<option value="">Selecione</option>';
        if (data && data.length > 0) {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.nome;
                option.textContent = item.nome;
                selectElement.appendChild(option);
            });
        } else {
            selectElement.innerHTML = '<option value="">Nenhum tipo encontrado</option>';
            showFeedback('Nenhum tipo de investimento encontrado na tabela NOMES. Crie alguns!', 'error');
        }
    }

    // Função para carregar e exibir **todos** os dados dos investimentos (sem filtro de user_id)
    async function carregarDados() {
        if (!currentUserId) {
            document.getElementById('loading-text').textContent = 'Faça login para ver os investimentos.';
            return;
        }

        const listContainer = document.getElementById('investimento-list');
        let loadingText = document.getElementById('loading-text');

        if (!supabaseConfigured) {
            if (loadingText) loadingText.textContent = 'Erro de Configuração do Supabase.';
            return;
        }

        loadingText.classList.remove('hidden');
        loadingText.textContent = 'Carregando investimentos...';

        // Limpa a lista
        Array.from(listContainer.children).forEach(child => {
            if (child.id !== 'loading-text') {
                listContainer.removeChild(child);
            }
        });

        // CRÍTICO: Consulta SEM filtro de user_id. Retorna todos os dados para usuários logados.
        const { data: investimentos, error } = await supabase.from('INVESTIMENTO').select(`
            id,
            nome,
            valor,
            entrada,
            retorno,
            haver
        `)
        .order('retorno', { ascending: true });

        if (error) {
            console.error('Erro ao carregar investimentos:', error);
            loadingText.textContent = `Erro ao carregar: ${error.message}. Verifique as políticas RLS na tabela INVESTIMENTO.`;
            showFeedback('Erro ao carregar investimentos: ' + error.message, 'error');
            return;
        }

        loadingText.classList.add('hidden');

        if (!investimentos || investimentos.length === 0) {
            loadingText.textContent = 'Nenhum investimento registrado ainda.';
            loadingText.classList.remove('hidden');
            atualizarGrafico([], []);
            document.getElementById('total-investido').textContent = formatarMoeda(0);
            document.getElementById('total-haver').textContent = formatarMoeda(0);
            return;
        }

        let totalInvestido = 0;
        let totalHaver = 0;
        const dadosGrafico = {};

        investimentos.forEach(inv => {
            const nomeInvestimento = inv.nome;
            const valor = parseFloat(inv.valor || 0);
            const haver = parseFloat(inv.haver || 0);

            totalInvestido += valor;
            totalHaver += haver;

            if (dadosGrafico[nomeInvestimento]) {
                dadosGrafico[nomeInvestimento] += valor;
            } else {
                dadosGrafico[nomeInvestimento] = valor;
            }

            const itemDiv = document.createElement('div');
            itemDiv.className = 'investment-item';

            const hoje = new Date();
            const dataRetorno = new Date(inv.retorno + 'T00:00:00');
            const diffTime = dataRetorno.getTime() - hoje.getTime();
            let diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let statusClass, statusText;

            if (diasRestantes < 0) {
                statusClass = 'btn-status-vencido';
                statusText = 'Vencido';
            } else if (diasRestantes === 0) {
                statusClass = 'btn-status-hoje';
                statusText = 'Hoje';
            } else if (diasRestantes <= 30) {
                statusClass = 'btn-status-proximo';
                statusText = `${diasRestantes} dias restantes`;
            } else {
                statusClass = 'btn-status-distantes';
                statusText = `${diasRestantes} dias restantes`;
            }

            itemDiv.innerHTML = `
                <div class="flex-grow">
                    <div class="font-extrabold text-xl text-indigo-800">${nomeInvestimento}</div>
                    <div class="text-base text-gray-600 mt-1">
                        <span class="font-medium text-gray-800">Investido:</span> ${formatarMoeda(valor)}
                        <span class="mx-2 text-gray-400">|</span>
                        <span class="font-medium text-gray-800">Resgate Estimado:</span> <span class="text-green-600 font-bold">${formatarMoeda(haver)}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        Início: ${new Date(inv.entrada + 'T00:00:00').toLocaleDateString('pt-BR')} | Resgate: ${new Date(inv.retorno + 'T00:00:00').toLocaleDateString('pt-BR')}
                    </div>
                </div>
                <div class="flex flex-col items-end flex-shrink-0 ml-4">
                    <span class="btn-status ${statusClass} mb-3">${statusText}</span>
                    <button data-id="${inv.id}" class="text-red-500 hover:text-red-700 text-sm font-semibold transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            listContainer.appendChild(itemDiv);
        });

        document.getElementById('total-investido').textContent = formatarMoeda(totalInvestido);
        document.getElementById('total-haver').textContent = formatarMoeda(totalHaver);
        atualizarGrafico(Object.keys(dadosGrafico), Object.values(dadosGrafico));

        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                showDeleteConfirmation(id);
            });
        });
    }

    // --- Funções do Modal de Exclusão ---
    function showDeleteConfirmation(id) {
        investmentToDeleteId = id;
        document.getElementById('delete-modal').classList.remove('hidden');
    }

    function hideDeleteConfirmation() {
        investmentToDeleteId = null;
        document.getElementById('delete-modal').classList.add('hidden');
    }
    // --- Fim Funções do Modal de Exclusão ---


    // Função para deletar um investimento (sem filtro por user_id)
    async function deletarInvestimento(id) {
        if (!supabaseConfigured || !currentUserId) {
            showFeedback('ERRO: Usuário não logado ou Supabase não configurado. Impossível deletar.', 'error');
            return;
        }

        // CRÍTICO: Delete SEM filtro de user_id. Qualquer usuário logado pode deletar qualquer registro.
        const { error } = await supabase
            .from('INVESTIMENTO')
            .delete()
            .eq('id', id);

        if (error) {
            console.error('Erro ao deletar investimento:', error);
            showFeedback('Erro ao deletar investimento: ' + error.message + '. Verifique as políticas RLS para DELETE.', 'error');
        } else {
            showFeedback('Investimento deletado com sucesso!');
            await carregarDados(); // Recarrega a lista
        }
    }


    // Função para inicializar/atualizar o gráfico Chart.js
    function atualizarGrafico(labels, data) {
        const ctx = document.getElementById('investimentoChart').getContext('2d');
        const colors = [
            '#4f46e5', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
            '#6366f1', '#2563eb', '#059669', '#d97706', '#dc2626'
        ];

        const datasets = [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            hoverOffset: 12,
            borderWidth: 2,
            borderColor: '#ffffff'
        }];

        if (investimentoChart) {
            investimentoChart.data.labels = labels;
            investimentoChart.data.datasets = datasets;
            investimentoChart.update();
        } else {
            investimentoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 10 },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Inter', size: 14 }, usePointStyle: true, padding: 20 } },
                        title: { display: false }
                    }
                }
            });
        }
    }

    // --- Listeners e Submissão do Formulário de Investimento ---
    document.getElementById('investimentoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!currentUserId) {
            showFeedback('Você precisa estar logado para cadastrar um investimento.', 'error');
            return;
        }

        // Desativa o botão e mostra o spinner
        submitButton.disabled = true;
        submitText.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');

        // Limpa mensagens de erro
        document.getElementById('valor_error').textContent = '';
        document.getElementById('resgate_error').textContent = '';
        document.getElementById('taxa_juros_error').textContent = '';
        let hasErrors = false;

        // Captura valores
        const nomeTipo = document.getElementById('nomeId').value;
        const taxaJurosPercentual = parseFloat(document.getElementById('taxaJuros').value);
        const valorFormatado = document.getElementById('valor').value;
        const valor = getValorNumerico(valorFormatado);
        const dataInicio = document.getElementById('entrada').value;
        const dataResgate = document.getElementById('retorno').value;
        const haver = document.getElementById('haver').value ? parseFloat(document.getElementById('haver').value) : null;

        // Validações
        if (!nomeTipo) { showFeedback('Por favor, selecione um Tipo de Investimento.', 'error'); hasErrors = true; }
        if (taxaJurosPercentual <= 0 || isNaN(taxaJurosPercentual)) { document.getElementById('taxa_juros_error').textContent = 'A taxa de juros deve ser maior que zero.'; hasErrors = true; }
        if (valor <= 0) { document.getElementById('valor_error').textContent = 'O valor deve ser positivo (R$ 0,01 ou mais).'; hasErrors = true; }
        if (dataInicio && dataResgate && new Date(dataInicio) >= new Date(dataResgate)) { document.getElementById('resgate_error').textContent = 'A data de resgate deve ser posterior à data de início.'; hasErrors = true; }

        if (hasErrors) {
            submitButton.disabled = false;
            submitText.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            return;
        }

        // CRÍTICO: Insere o novo registro SEM user_id (dados compartilhados)
        const { error } = await supabase
            .from('INVESTIMENTO')
            .insert([{
                nome: nomeTipo,
                valor: valor,
                entrada: dataInicio,
                retorno: dataResgate,
                haver: haver,
            }]);

        // Reativa o botão e esconde o spinner
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        loadingSpinner.classList.add('hidden');

        if (error) {
            console.error('Erro ao salvar investimento:', error);
            showFeedback(`Erro ao salvar: ${error.message}. Verifique as políticas RLS para INSERT.`, 'error');
        } else {
            showFeedback('Investimento salvo com sucesso!');
            document.getElementById('investimentoForm').reset();
            document.getElementById('dias-totais-display').textContent = '0 dias';
            document.getElementById('taxaJuros').value = '10.00';
            // Recalcula o haver para o formulário resetado (deve ser 0)
            calcularEExibirHaverEDias();
            await carregarDados();
        }
    });

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Inicializa o listener de autenticação
        setupAuthListener();

        // 2. Define a data de início como hoje por padrão
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('entrada').value = today;

        // 3. Listeners do formulário principal
        const valorEl = document.getElementById('valor');
        valorEl.addEventListener('input', formatarInputMoeda);
        document.getElementById('entrada').addEventListener('input', calcularEExibirHaverEDias);
        document.getElementById('retorno').addEventListener('input', calcularEExibirHaverEDias);
        document.getElementById('retorno').addEventListener('change', calcularEExibirHaverEDias);
        document.getElementById('taxaJuros').addEventListener('input', calcularEExibirHaverEDias);

        // 4. Listeners para o Modal de Exclusão
        document.getElementById('cancel-delete').addEventListener('click', hideDeleteConfirmation);
        document.getElementById('confirm-delete').addEventListener('click', () => {
            if (investmentToDeleteId) {
                deletarInvestimento(investmentToDeleteId);
            }
            hideDeleteConfirmation();
        });

        // 5. Listeners de Autenticação
        document.getElementById('auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            handleAuth(email, password);
        });

        document.getElementById('auth-switch-mode').addEventListener('click', toggleAuthMode);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
    });
  </script>
</body>
</html>
