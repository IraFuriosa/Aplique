<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Investimentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJdE52J1pQ0+wAfrrK5zQ78T7y6mG+W4jWd0P/D0sF0O00g/O0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --success: #10b981;
      --error: #ef4444;
      --background-light: #f9fafb;
      --card-bg: #ffffff;
    }

    /* Estilo global aprimorado */
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-light); /* Fundo mais suave */
      color: #1f2937;
      min-height: 10vh;
      display: flex;
      flex-direction: column;
    }

    /* Estilos personalizados para botões usando @apply do Tailwind */
    .btn {
    @apply font-semibold py-2.5 px-4 rounded-lg transition duration-150 ease-in-out shadow-sm;
    }

    .btn:disabled {
      @apply opacity-50 cursor-not-allowed;
    }

    .btn-primary {
      @apply bg-[var(--primary)] text-white hover:bg-[var(--primary-dark)] focus:outline-none focus:ring-4 focus:ring-[var(--primary)] focus:ring-offset-2;
    }

    .btn-secondary {
      @apply bg-gray-200 text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-offset-2;
    }

    .btn-delete {
      /* Ajuste para alinhar o ícone e o texto */
      @apply bg-[var(--error)] text-white hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-[var(--error)] focus:ring-offset-2;
    }

    .btn-success {
      @apply bg-[var(--success)] text-white hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-[var(--success)] focus:ring-offset-2;
    }

    /* Ajuste para o formulário */
    .input-field {
     @apply p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary)] focus:border-[var(--primary)] w-full box-border;
    }

    /* Estilo para a mensagem de feedback/toast */
    #feedback-message {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        z-index: 1000;
        transform: translateY(100%);
    }

    #feedback-message.show {
        transform: translateY(0);
        opacity: 1;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <div id="feedback-message" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-xl opacity-0 translate-y-full max-w-sm">
    <p id="feedback-text" class="font-medium"></p>
  </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Confirmar Exclusão</h2>
            <p class="mb-6 text-gray-600">Tem certeza que deseja excluir este investimento? Esta ação é irreversível e o investimento será removido de **todos** os usuários, pois a carteira é compartilhada.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-delete" class="btn btn-delete">Excluir</button>
            </div>
        </div>
    </div>

    <div id="auth-container" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
    <div class="bg-gradient-to-r from-[var(--primary)] to-[var(--primary-dark)] p-6 text-center">
      <h1 class="text-2xl font-bold text-white">Gestão Financeira</h1>
    </div>
    <div class="p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-5 text-center">Acesso (Login)</h2>
      <form id="auth-form" class="space-y-5">
        <div>
          <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1.5">Email</label>
          <input
            type="email"
            id="auth-email"
            class="input-field w-full"
            placeholder="seu.email@exemplo.com"
            required
          />
        </div>
        <div>
          <div class="flex justify-between items-center mb-1.5">
            <label for="auth-password" class="block text-sm font-medium text-gray-700">Senha</label>
          </div>
          <input
            type="password"
            id="auth-password"
            class="input-field w-full"
            placeholder="••••••••"
            required
          />
        </div>
        <button type="submit" id="login-button" class="btn btn-primary w-full py-3 text-base">
          Entrar
        </button>
        <p class="text-center text-sm text-gray-500 pt-2">
            Não é permitido criar novas contas. Apenas acesso a usuários existentes.
        </p>
      </form>
    </div>
  </div>
</div>

    <div id="app-container" class="hidden">
        <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center">
                <p class="text-sm text-gray-500 mr-4">Logado como:</p>
                <p id="user-email-display" class="font-medium text-gray-800 break-all"></p>
                <p id="user-id-display" class="text-xs text-gray-400 mt-1 sm:mt-0 sm:ml-4"></p>
            </div>
            <button id="logout-button" class="btn btn-secondary ml-4">Sair</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl h-fit">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Cadastrar Novo Investimento</h2>
                <form id="investimentoForm" class="space-y-4">

                    <div>
                        <label for="nomeTipo" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <select id="nomeTipo" class="input-field" required>
                            <option value="" disabled selected>Carregando...</option>
                        </select>
                    </div>

                    <div>
                        <label for="taxaJuros" class="block text-sm font-medium text-gray-700 mb-1">Taxa de Juros Mensal (%)</label>
                        <input type="number" id="taxaJuros" class="input-field" placeholder="Ex: 10" step="0.01" min="0" required>
                    </div>

                  <div>
                     <label for="valor" class="block text-sm font-medium text-gray-700 mb-1">Valor Investido (R$)</label>
                     <input type="text" id="valor" class="input-field" placeholder="R$ 1.000,00" required>
                 </div>
                 <div>
                    <label for="haverEstimado" class="block text-sm font-medium text-gray-700 mb-1">Valor de Resgate (R$)</label>
                     <input type="text" id="haverEstimado" class="input-field" placeholder="R$ 1.200,00" required>
                </div>

                    <div>
                        <label for="entrada" class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label>
                        <input type="date" id="entrada" class="input-field" required>
                    </div>

                    <div>
                        <label for="retorno" class="block text-sm font-medium text-gray-700 mb-1">Data de Resgate Programado</label>
                        <input type="date" id="retorno" class="input-field" required>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-2">
                        <div>
                            <p class="text-sm font-medium text-gray-700">Prazo Total em Dias:</p>
                            <p id="diasTotaisDisplay" class="font-bold text-lg text-[var(--primary)]">0 Dias</p>
                        </div>
             </div>                    
               <button type="submit" class="btn btn-primary w-full">Adicionar Investimento</button>
                </form>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Resumo da Carteira (Global)</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-[var(--primary)] text-white p-4 rounded-lg shadow-inner">
                            <p class="text-sm opacity-90">Total Investido:</p>
                            <p id="totalInvestidoDisplay" class="text-2xl font-extrabold">R$ 0,00</p>
                        </div>
                        <div class="bg-[var(--success)] text-white p-4 rounded-lg shadow-inner">
                            <p class="text-sm opacity-90">Total a Resgatar (Haver Estimado):</p>
                            <p id="totalHaverDisplay" class="text-2xl font-extrabold">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Distribuição da Carteira (Gráfico)</h3>
                    <div class="relative max-w-md mx-auto h-72">
                        <canvas id="investimentoChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Carteira Compartilhada</h2>
                    <div id="investimento-list" class="space-y-4">
                        <p class="text-gray-500 text-center py-4" id="loading-message">Carregando investimentos...</p>
                        </div>
                </div>
            </div>
        </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="module">
    // Variáveis globais de ambiente (Assumindo que são fornecidas pelo ambiente)
    const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://odaalhsghdmpyhgnblml.supabase.co';
    const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kYWFsaHNnaGRtcHloZ25ibG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzMyODUsImV4cCI6MjA3NjU0OTI4NX0.J3bgvqGOh2KsNPhuQbnAcGsmNnsqxktIygOpJqr1cHM';

    // Constantes
    const DIAS_NO_MES = 30.4375; 
    const PRIMARY_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
    const SUCCESS_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--success').trim();
    const ERROR_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--error').trim();
    const COLORS = [PRIMARY_COLOR, SUCCESS_COLOR, '#3b82f6', '#f59e0b', '#14b8a6', '#8b5cf6', '#ec4899', '#f97316'];
    
    // --- ADICIONADO: Variáveis para controle de inatividade e cálculo bidirecional ---
    let inactivityTimer;
    const INACTIVITY_TIMEOUT_MS = 1800000; // 30 minutos em milissegundos
    let isUpdatingFromValor = false;
    let isUpdatingFromHaver = false;
    // --- FIM VARIÁVEIS ADICIONADAS ---

    // Instâncias Supabase
    let supabaseClient = null; 
    let currentUserId = null; 
    let investmentChart = null;
    let investmentToDeleteId = null; 
    let realtimeChannel = null;

    // Nomes das tabelas
    const TABLE_INVESTIMENTOS = 'INVESTIMENTO';
    const TABLE_NOMES = 'NOMES';


    // --- UTILS ---

    function showFeedback(message, type = 'success') {
        const feedbackEl = document.getElementById('feedback-message');
        const textEl = document.getElementById('feedback-text');

        if (!feedbackEl || !textEl) return; 

        const classes = {
            'success': 'bg-[var(--success)] text-white',
            'error': 'bg-[var(--error)] text-white',
            'info': 'bg-[var(--primary)] text-white'
        };

        feedbackEl.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-xl opacity-0 max-w-sm';
        const classListToAdd = (classes[type] || classes['info']).split(' ');
        feedbackEl.classList.add(...classListToAdd); 

        textEl.textContent = message;

        setTimeout(() => {
            feedbackEl.classList.add('show', 'opacity-100');
        }, 10);

        setTimeout(() => {
            feedbackEl.classList.remove('show', 'opacity-100');
        }, 4000);
    }
    
    function formatarMoeda(valor) {
        if (typeof valor !== 'number' || isNaN(valor)) return 'R$ 0,00';
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function parseMoedaParaNumero(valorStr) {
         if (!valorStr) return 0;
        return parseFloat(valorStr.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
    }

    function formatarInputMoeda(e) {
        let value = e.target.value.replace(/\D/g, '');
        let floatValue = parseFloat(value) / 100;
        if (isNaN(floatValue)) floatValue = 0;
        e.target.value = formatarMoeda(floatValue).replace('R$', '').trim();
    }

    // Calcular Haver (resgate) a partir do valor investido
    function calcularHaver(valor, taxaMensal, diasTotais) {
        if (diasTotais <= 0 || valor <= 0 || taxaMensal <= 0) return 0;
        const meses = diasTotais / DIAS_NO_MES;
        const taxaDecimal = taxaMensal / 100;
        return valor * Math.pow(1 + taxaDecimal, meses);
    }

    // --- ADICIONADO: Cálculo inverso ---
    // Calcular valor investido a partir do Haver (resgate)
    function calcularValorInvestido(haver, taxaMensal, diasTotais) {
        if (diasTotais <= 0 || haver <= 0 || taxaMensal <= 0) return 0;
        const meses = diasTotais / DIAS_NO_MES;
        const taxaDecimal = taxaMensal / 100;
        return haver / Math.pow(1 + taxaDecimal, meses);
    }
    // --- FIM ADICIONADO ---
    
    // --- ADICIONADO: Função para cálculo bidirecional ---
    function calcularValoresBidirecionais() {
        const valorEl = document.getElementById('valor');
        const haverEl = document.getElementById('haverEstimado');
        const taxaInput = parseFloat(document.getElementById('taxaJuros')?.value) || 0;
        const entradaInput = document.getElementById('entrada')?.value;
        const retornoInput = document.getElementById('retorno')?.value;

        // Se faltarem dados essenciais para o cálculo (taxa, datas), apenas atualiza o prazo
        if (!taxaInput || !entradaInput || !retornoInput) {
             document.getElementById('diasTotaisDisplay').textContent = '0 Dias';
             return;
        }

        // Calcular dias totais
        const dataInicio = new Date(entradaInput);
        const dataResgate = new Date(retornoInput);
        const diffTime = Math.abs(dataResgate.getTime() - dataInicio.getTime());
        const diasTotais = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        document.getElementById('diasTotaisDisplay').textContent = `${diasTotais} Dias`;
        
        // Verifica se as datas são válidas
        if (diasTotais <= 0) return;

        // 1. Atualizar Haver se Valor foi alterado (e não está sendo atualizado por Haver)
        if (valorEl && !isUpdatingFromHaver) {
            const valor = parseMoedaParaNumero(valorEl.value);
            if (valor > 0) {
                const haver = calcularHaver(valor, taxaInput, diasTotais);
                if (haver > 0 && haverEl) {
                    isUpdatingFromValor = true;
                    haverEl.value = formatarMoeda(haver).replace('R$', '').trim();
                    setTimeout(() => isUpdatingFromValor = false, 50);
                }
            }
        }

        // 2. Atualizar Valor se Haver foi alterado (e não está sendo atualizado por Valor)
        if (haverEl && !isUpdatingFromValor) {
            const haver = parseMoedaParaNumero(haverEl.value);
            if (haver > 0) {
                const valor = calcularValorInvestido(haver, taxaInput, diasTotais);
                if (valor > 0 && valorEl) {
                    isUpdatingFromHaver = true;
                    valorEl.value = formatarMoeda(valor).replace('R$', '').trim();
                    setTimeout(() => isUpdatingFromHaver = false, 50);
                }
            }
        }
    }
    // --- FIM ADICIONADO ---
    
    // --- ADICIONADO: Funções de Logout por Inatividade ---
    function resetInactivityTimer() {
        if (!currentUserId) return;
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(handleInactivityLogout, INACTIVITY_TIMEOUT_MS);
    }

    function handleInactivityLogout() {
        if (currentUserId) {
            showFeedback('Sessão encerrada por inatividade.', 'info');
            handleLogout(); 
        }
    }
    
    function setupInactivityListeners() {
        const activityEvents = ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'];
        activityEvents.forEach(event => {
            document.addEventListener(event, resetInactivityTimer, false);
        });
    }
    // --- FIM ADICIONADO ---


    // --- SUPABASE / AUTH ---

    async function initializeSupabase() {
        try {
            if (SUPABASE_URL.includes('your-supabase-url') || SUPABASE_ANON_KEY.includes('your-anon-key')) {
                console.error("Supabase Configuração não definida.");
                showFeedback('Erro de configuração: Chaves do Supabase não definidas.', 'error');
                return;
            }
            
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error("Supabase CDN não carregado corretamente.");
                showFeedback('Erro fatal: Supabase CDN não carregado. Verifique a conexão.', 'error');
                return;
            }
            
            supabaseClient.auth.onAuthStateChange((event, session) => {
                const authContainer = document.getElementById('auth-container');
                const appContainer = document.getElementById('app-container');
                const user = session?.user;

                if (user) {
                    currentUserId = user.id;
                    const emailDisplay = document.getElementById('user-email-display');
                    const idDisplay = document.getElementById('user-id-display');
                    
                    if (emailDisplay) emailDisplay.textContent = user.email || 'Anônimo';
                    if (idDisplay) idDisplay.textContent = `ID: ${user.id}`;
                    
                    if (authContainer) authContainer.classList.add('hidden');
                    if (appContainer) appContainer.classList.remove('hidden');
                    
                    loadNames(); 
                    startDataListener();
                    
                    resetInactivityTimer(); // INICIA o monitor de inatividade
                } else {
                    currentUserId = null;
                    clearTimeout(inactivityTimer); // Para o monitor de inatividade
                    if (realtimeChannel) {
                        supabaseClient.removeChannel(realtimeChannel);
                        realtimeChannel = null;
                    }
                    if (authContainer) authContainer.classList.remove('hidden');
                    if (appContainer) appContainer.classList.add('hidden');
                }
            });

        } catch (error) {
            console.error("Erro na inicialização do Supabase:", error);
            showFeedback('Erro ao iniciar a aplicação. Verifique a configuração do Supabase.', 'error');
        }
    }

    // --- MODIFICADO: Apenas login, sem cadastro ---
    async function handleAuth(email, password) {
       if (!supabaseClient) return;
        const submitButton = document.getElementById('login-button');
        if (!submitButton) return;

        submitButton.disabled = true;
        submitButton.textContent = 'Entrando...';

        try {
            // Tenta apenas o login
            const result = await supabaseClient.auth.signInWithPassword({ email, password });
            if (result.error) throw result.error;
            showFeedback('Login realizado com sucesso!');
        } catch (error) {
            console.error("Erro de autenticação Supabase:", error);
            // Mensagem clara sobre a ausência de cadastro
            let errorMessage = "Credenciais inválidas. Não é permitido criar novas contas.";
            showFeedback(errorMessage, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Entrar';
        }
    }
    // --- FIM MODIFICADO ---
    
    // --- MODIFICADO: Adicionado limpeza do timer de inatividade ---
    async function handleLogout() {
        if (!supabaseClient) return;

        try {
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
            showFeedback('Você saiu da conta.', 'info');
            clearTimeout(inactivityTimer); 
            // O onAuthStateChange cuidará da transição de UI
        } catch (error) {
            console.error("Erro ao fazer logout:", error);
            showFeedback('Erro ao fazer logout.', 'error');
        }
    }
    // --- FIM MODIFICADO ---

    // --- DATA / SUPABASE POSTGRES ---

    async function loadNames() {
        if (!supabaseClient) return;
        const selectEl = document.getElementById('nomeTipo');
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="" disabled selected>Carregando Tipos...</option>`; 

        try {
            let { data: nomes, error } = await supabaseClient
                .from(TABLE_NOMES)
                .select('nome')
                .order('nome', { ascending: true });

            if (error) throw error;

            if (!nomes || nomes.length === 0) {
                const initialNames = [
                    { nome: "Ações" },
                    { nome: "Renda Fixa" },
                    { nome: "FIIs" },
                    { nome: "Criptomoedas" }
                ];
                await supabaseClient.from(TABLE_NOMES).insert(initialNames);
                nomes = initialNames; 
            }
            
            selectEl.innerHTML = '<option value="" disabled selected>Selecione</option>';
            nomes.forEach(item => {
                selectEl.innerHTML += `<option value="${item.nome}">${item.nome}</option>`;
            });

            selectEl.removeAttribute('disabled');
        } catch (error) {
            console.error("Erro ao carregar nomes de investimento Supabase:", error);
            selectEl.innerHTML = `<option value="" disabled selected>Erro ao carregar tipos</option>`;
            showFeedback('Erro ao carregar a lista de tipos de investimento.', 'error');
        }
    }

    async function adicionarInvestimento(e) {
        e.preventDefault();

        if (!currentUserId) {
            showFeedback('Erro: Usuário não autenticado. Faça login para adicionar.', 'error');
            return;
        }

        const form = e.target;
        const nomeTipo = form.nomeTipo.value;
        const taxaJuros = parseFloat(form.taxaJuros.value);
        // Usa o haverEstimado, pois este é o valor que o usuário pode ter inserido ou que foi calculado
        const haverNumerico = parseMoedaParaNumero(form.haverEstimado.value);
        const valorNumerico = parseMoedaParaNumero(form.valor.value); // O valor Investido final
        const dataInicio = form.entrada.value;
        const dataResgate = form.retorno.value;

        
        if (valorNumerico <= 0 || haverNumerico <= 0) {
             showFeedback('Os valores de Investido e Haver Estimado devem ser maiores que zero.', 'error');
             return;
        }


        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Adicionando...';
        
        try {
            const { error } = await supabaseClient
                .from(TABLE_INVESTIMENTOS)
                .insert([{
                    nome: nomeTipo,
                    valor: valorNumerico, // Valor Investido
                    entrada: dataInicio,
                    retorno: dataResgate,
                    haver: haverNumerico, // Valor de Resgate
                    taxaJuros: taxaJuros, // Taxa de Juros (adicionado ao objeto de inserção)
                }]);

            if (error) throw error;

            showFeedback('Investimento adicionado com sucesso!');
            form.reset();
            // Resetar displays de cálculo após envio
            document.getElementById('diasTotaisDisplay').textContent = '0 Dias';

        } catch (error) {
            console.error("Erro ao adicionar investimento Supabase:", error);
            showFeedback('Erro ao adicionar investimento. Tente novamente.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Adicionar Investimento';
        }
    }
    
    function showDeleteConfirmation(id) {
        const modal = document.getElementById('delete-modal');
        if (!modal) return;
        investmentToDeleteId = id;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function hideDeleteConfirmation() {
        const modal = document.getElementById('delete-modal');
        if (!modal) return;
        investmentToDeleteId = null;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    async function deletarInvestimento(id) {
        if (!supabaseClient) return;

        try {
            const { error } = await supabaseClient
                .from(TABLE_INVESTIMENTOS)
                .delete()
                .eq('id', id); 

            if (error) throw error;
            showFeedback('Investimento excluído com sucesso!', 'info');
        } catch (error) {
            console.error("Erro ao deletar investimento Supabase:", error);
            showFeedback('Erro ao excluir investimento. Tente novamente.', 'error');
        }
    }

    function startDataListener() {
        if (!supabaseClient) return;

        if (realtimeChannel) {
            supabaseClient.removeChannel(realtimeChannel);
        }

        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) loadingMessage.textContent = 'Carregando investimentos...';

        realtimeChannel = supabaseClient
            .channel('investimento_changes')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: TABLE_INVESTIMENTOS }, 
                (payload) => {
                    console.log('Realtime change received!', payload.eventType, payload.new || payload.old);
                    fetchAndRenderData();
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('Realtime Subscribed.');
                    fetchAndRenderData(); 
                } else if (status === 'CHANNEL_ERROR') {
                    console.error('Realtime Channel Error');
                    if (loadingMessage) loadingMessage.textContent = 'Erro de Realtime. Tentando nova busca...';
                    fetchAndRenderData(); 
                }
            });
    }

    async function fetchAndRenderData() {
        if (!supabaseClient) return;
        const loadingMessage = document.getElementById('loading-message');

        try {
            const { data: investimentos, error } = await supabaseClient
                .from(TABLE_INVESTIMENTOS)
                .select('*')
                .order('retorno', { ascending: true });

            if (error) throw error;

            renderInvestments(investimentos);
            updateSummaryAndChart(investimentos);

            if (investimentos.length === 0) {
                 if (loadingMessage) loadingMessage.textContent = 'Nenhum investimento encontrado. Adicione um novo abaixo.';
            } else {
                 if (loadingMessage) loadingMessage.textContent = '';
            }
        } catch (error) {
            console.error("Erro ao buscar dados Supabase:", error);
            showFeedback('Erro ao buscar dados do Supabase. Verifique RLS ou conexão.', 'error');
            if (loadingMessage) loadingMessage.textContent = 'Erro ao carregar dados.';
        }
    }


    // --- RENDERING & CHART ---

    function renderInvestments(investimentos) {
        const listEl = document.getElementById('investimento-list');
        if (!listEl) return;
        listEl.innerHTML = ''; 

        if (investimentos.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum investimento registrado na carteira compartilhada.</p>';
            return;
        }

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0); 

        investimentos.forEach(inv => {
            const dataRetorno = new Date(inv.retorno);
            dataRetorno.setHours(0, 0, 0, 0);

            const diffTime = dataRetorno.getTime() - hoje.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let statusText, statusClass;

            if (diffDays < 0) {
                statusText = 'Vencido';
                statusClass = 'bg-red-100 text-[var(--error)]';
            } else if (diffDays === 0) {
                statusText = 'Hoje';
                statusClass = 'bg-yellow-100 text-yellow-700';
            } else if (diffDays <= 30) {
                statusText = `Próximo (${diffDays} dias)`;
                statusClass = 'bg-yellow-100 text-yellow-700';
            } else {
                statusText = `Distantes (${diffDays} dias)`;
                statusClass = 'bg-green-100 text-[var(--success)]';
            }

            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <h4 class="text-lg font-bold text-gray-800">${inv.nome}</h4>
                    <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusClass}">${statusText}</span>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-3 text-sm">
                    <p><span class="font-medium">Investido:</span> <span class="text-[var(--primary)] font-semibold">${formatarMoeda(inv.valor)}</span></p>
                    <p><span class="font-medium">Resgate Est.:</span> <span class="text-[var(--success)] font-semibold">${formatarMoeda(inv.haver)}</span></p>
                    <p><span class="font-medium">Início:</span> ${inv.entrada}</p>
                    <p><span class="font-medium">Resgate:</span> ${inv.retorno}</p>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end">
                    <button data-id="${inv.id}" class="btn-delete text-sm py-1 px-3 flex items-center space-x-1">
                        <i class="fas fa-trash-alt"></i>
                        <span>Excluir</span>
                    </button>
                </div>
            `;
            
            const deleteBtn = card.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    showDeleteConfirmation(id);
                });
            }

            listEl.appendChild(card);
        });
    }

    function updateSummaryAndChart(investimentos) {
        let totalInvestido = 0;
        let totalHaver = 0;
        const dataForChart = {};

        investimentos.forEach(inv => {
            totalInvestido += inv.valor || 0;
            totalHaver += inv.haver || 0;

            const nome = inv.nome;
            dataForChart[nome] = (dataForChart[nome] || 0) + (inv.valor || 0);
        });

        const totalInvestidoDisplay = document.getElementById('totalInvestidoDisplay');
        const totalHaverDisplay = document.getElementById('totalHaverDisplay');
        if (totalInvestidoDisplay) totalInvestidoDisplay.textContent = formatarMoeda(totalInvestido);
        if (totalHaverDisplay) totalHaverDisplay.textContent = formatarMoeda(totalHaver);

        const labels = Object.keys(dataForChart);
        const dataValues = Object.values(dataForChart);
        const backgroundColors = labels.map((_, index) => COLORS[index % COLORS.length]);

        const chartCanvas = document.getElementById('investimentoChart');
        if (!chartCanvas) return; 

        if (investmentChart) {
            investmentChart.data.labels = labels;
            investmentChart.data.datasets[0].data = dataValues;
            investmentChart.data.datasets[0].backgroundColor = backgroundColors;
            investmentChart.update();
        } else {
            const ctx = chartCanvas.getContext('2d');
            investmentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10,
                                font: {
                                    family: 'Inter',
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }
    }


    // --- Inicialização e Listeners ---

    window.onload = function () {
        // Inicializa Supabase e Autenticação
        initializeSupabase(); 
        
        // ADICIONADO: Configura os listeners de atividade para o logout por inatividade
        setupInactivityListeners();

        // 1. Listener para adicionar novo investimento
        const invForm = document.getElementById('investimentoForm');
        if (invForm) invForm.addEventListener('submit', adicionarInvestimento);

        // 2. Listeners para cálculos bidirecionais automáticos no formulário
        const valorEl = document.getElementById('valor');
        const haverEl = document.getElementById('haverEstimado');
        const taxaJurosEl = document.getElementById('taxaJuros');
        const entradaEl = document.getElementById('entrada');
        const retornoEl = document.getElementById('retorno');

        // Formatação de Moeda
        if (valorEl) valorEl.addEventListener('input', formatarInputMoeda);
        if (haverEl) haverEl.addEventListener('input', formatarInputMoeda);

        // Disparo do cálculo bidirecional a cada alteração nos campos relevantes
        [valorEl, haverEl, taxaJurosEl, entradaEl, retornoEl].forEach(el => {
            if (el) el.addEventListener('input', calcularValoresBidirecionais);
        });


        // 3. Listeners para o Modal de Exclusão
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);

        const confirmDeleteBtn = document.getElementById('confirm-delete');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                if (investmentToDeleteId) {
                    deletarInvestimento(investmentToDeleteId);
                }
                hideDeleteConfirmation();
            });
        }

        // 4. Listeners de Autenticação
        const authForm = document.getElementById('auth-form');
        if (authForm) {
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email')?.value;
                const password = document.getElementById('auth-password')?.value;
                if (email && password) handleAuth(email, password);
            });
        }
       
        const logoutBtn = document.getElementById('logout-button');
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    };
  </script>
</body>
</html>
